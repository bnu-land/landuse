/*
 * File: app/view/db_UserRoleSettingWindow.js
 *
 * This file was generated by Sencha Architect version 3.1.0.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 5.0.x library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 5.0.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('MyApp.view.db_UserRoleSettingWindow', {
    extend: 'Ext.window.Window',
    alias: 'widget.db_UserRoleSettingWindow',

    requires: [
        'MyApp.view.db_UserRoleSettingWindowViewModel',
        'Ext.grid.Panel',
        'Ext.grid.column.RowNumberer',
        'Ext.grid.View',
        'Ext.toolbar.Toolbar',
        'Ext.toolbar.Fill',
        'Ext.form.field.Text',
        'Ext.button.Button',
        'Ext.toolbar.Spacer',
        'Ext.selection.CheckboxModel'
    ],

    viewModel: {
        type: 'db_UserRoleSettingWindow'
    },
    height: 283,
    id: 'db_UserRoleSettingWindow',
    width: 467,
    layout: 'fit',
    title: '用户角色设置',
    defaultListenerScope: true,

    initConfig: function(instanceConfig) {
        var me = this,
            config = {
                items: [
                    {
                        xtype: 'gridpanel',
                        id: 'db_UserRoleSettingWindowForm',
                        store: 'uRoleInfoStore',
                        columns: [
                            {
                                xtype: 'rownumberer'
                            },
                            {
                                xtype: 'gridcolumn',
                                id: 'urSet_roleNameCn',
                                width: 100,
                                dataIndex: 'roleNameCn',
                                text: '角色名称'
                            },
                            {
                                xtype: 'gridcolumn',
                                id: 'urSet_roleName',
                                width: 100,
                                dataIndex: 'roleName',
                                text: '角色代码'
                            },
                            {
                                xtype: 'gridcolumn',
                                id: 'urSet_description',
                                width: 200,
                                dataIndex: 'description',
                                text: '角色说明'
                            }
                        ],
                        dockedItems: [
                            {
                                xtype: 'toolbar',
                                dock: 'bottom',
                                items: [
                                    {
                                        xtype: 'tbfill'
                                    },
                                    {
                                        xtype: 'textfield',
                                        id: 'db_userRoleSettingUserNameLbl',
                                        fieldLabel: 'Label'
                                    },
                                    {
                                        xtype: 'button',
                                        handler: function() {
                                            var win = Ext.getCmp('db_UserRoleSettingWindow');
                                            win.close();
                                        },
                                        text: '取消'
                                    },
                                    {
                                        xtype: 'tbspacer',
                                        width: 10
                                    },
                                    {
                                        xtype: 'button',
                                        text: '确定',
                                        listeners: {
                                            click: 'onButtonClick'
                                        }
                                    }
                                ]
                            }
                        ],
                        selModel: Ext.create('Ext.selection.CheckboxModel', {
                            selType: 'checkboxmodel'
                        })
                    }
                ]
            };
        if (instanceConfig) {
            me.getConfigurator().merge(me, config, instanceConfig);
        }
        return me.callParent([config]);
    },

    onButtonClick: function(button, e, eOpts) {
        var win = Ext.getCmp('db_UserRoleSettingWindow');


        var grid = Ext.getCmp('db_UserRoleSettingWindowForm');
        var records = grid.getSelection();
        if (records.length === 0) {
            Ext.Msg.alert('提示', '请选择一个用户角色。');
            return;
        } else if (records.length > 1) {
            Ext.Msg.alert('提示', '每个用户只有一个角色。');
            return;
        }
        var record = records[0];

        var userName= Ext.getCmp('db_userRoleSettingUserNameLbl').getValue();
        var roleId = record.get('roleId');
        Ext.Msg.confirm('您正在设置', '用户：' + userName + '为：'+record.get('roleNameCn')+'角色，<br/> 确认设置？', getResult);
        function getResult(confirm)
        {
            if (confirm == "yes"){
                Ext.Ajax.request(
                {
                    url : 'update_UserRole',
                    params :
                    {
                        username : userName,
                        roleid : roleId
                    },
                    success : function (response){
                        Ext.Msg.alert('成功提示', '角色设置成功。');
                        var mystore = Ext.StoreMgr.get('uUserRoleStore');
                        mystore.load();
                        win.close();
                    },
                    failure : function (response){
                    }
                });
            }
        }
    }

});