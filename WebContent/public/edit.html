<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>By：DragonDean</title>
    <script type="text/javascript">
    //下面用于图片上传预览功能
    function setImagePreview(avalue) {
        var docObj = document.getElementById("doc");

        var imgObjPreview = document.getElementById("preview");
        if (docObj.files && docObj.files[0]) {
            //火狐下，直接设img属性
            imgObjPreview.style.display = 'block';
            imgObjPreview.style.width = '300px';
            imgObjPreview.style.height = '360px';
            //imgObjPreview.src = docObj.files[0].getAsDataURL();

            //火狐7以上版本不能用上面的getAsDataURL()方式获取，需要一下方式
            console.log(window.URL.createObjectURL(docObj.files[0]));
            imgObjPreview.src = window.URL.createObjectURL(docObj.files[0]);
        } else {
            //IE下，使用滤镜
            docObj.select();
            var imgSrc = document.selection.createRange().text;
            var localImagId = document.getElementById("localImag");
            //必须设置初始大小
            localImagId.style.width = "300px";
            localImagId.style.height = "360px";
            //图片异常的捕捉，防止用户修改后缀来伪造图片
            try {
                localImagId.style.filter = "progid:DXImageTransform.Microsoft.AlphaImageLoader(sizingMethod=scale)";
                localImagId.filters.item("DXImageTransform.Microsoft.AlphaImageLoader").src = imgSrc;
            } catch (e) {
                alert("您上传的图片格式不正确，请重新选择!");
                return false;
            }
            imgObjPreview.style.display = 'none';
            document.selection.empty();
        }
        return true;
    }

    function uploadAndSubmit() {
        var form = document.forms["demoForm"];

        if (form["file"].files.length > 0) {
            // 寻找表单域中的 <input type="file" ... /> 标签
            var file = form["file"].files[0];
            // try sending 
            var reader = new FileReader();

            reader.onloadstart = function() {
                // 这个事件在读取开始时触发
                console.log("onloadstart");
                document.getElementById("bytesTotal").textContent = file.size;
            }
            reader.onprogress = function(p) {
                // 这个事件在读取进行中定时触发
                console.log("onprogress");
                document.getElementById("bytesRead").textContent = p.loaded;
            }

            reader.onload = function() {
                // 这个事件在读取成功结束后触发
                console.log("load complete");
            }

            reader.onloadend = function() {
                // 这个事件在读取结束后，无论成功或者失败都会触发
                if (reader.error) {
                    console.log(reader.error);
                } else {
                    document.getElementById("bytesRead").textContent = file.size;
                    // 构造 XMLHttpRequest 对象，发送文件 Binary 数据
                    var xhr = new XMLHttpRequest();
                    xhr.open( /* method */ "POST",
                        /* target url */
                        "upload.jsp?fileName=" + file.name
                        /*, async, default to true */
                    );
                    if (!XMLHttpRequest.prototype.sendAsBinary) {
                        XMLHttpRequest.prototype.sendAsBinary = function(datastr) {
                            function byteValue(x) {
                                return x.charCodeAt(0) & 0xff;
                            }
                            var ords = Array.prototype.map.call(datastr, byteValue);
                            var ui8a = new Uint8Array(ords);
                            this.send(ui8a.buffer);
                        }
                    }
                    xhr.overrideMimeType("application/octet-stream");
                    xhr.sendAsBinary(reader.result);
                    xhr.onreadystatechange = function() {
                        if (xhr.readyState == 4) {
                            if (xhr.status == 200) {
                                console.log("上传完成");
                                console.log("response: " + xhr.responseText);
                            }
                        }
                    }
                }
            }

            reader.readAsBinaryString(file);
        } else {
            alert("请选择要上传的文件");
        }
    }
    </script>
</head>

<body>
    <table width="100%" border="0" cellspacing="0" cellpadding="0">
        <tbody>
            <tr>
                <td height="101" align="center">
                    <div id="localImag"><img id="preview" src="http://blog.chuangling.net/Public/images/top.jpg" width="300" height="360" style="display: block; width: 300px; height: 360px;"></div>
                </td>
            </tr>
            <tr>
                <td align="center" style="padding-top:10px;">
                    <input type="file" name="file" id="doc" style="width:300px;" onchange="javascript:setImagePreview();">
                </td>
            </tr>
            <a id="ctl00_ContentPlaceHolder1_DetailsView1_Dlattlist_ctl01_HyperLink1" href="files/0714.docx" target="_blank">黑龙江开发区系统调整报告</a>
        </tbody>
    </table>
    <h1>File API Demo</h1>
    <p>
        <!-- 用于文件上传的表单元素 -->
        <form name="demoForm" id="demoForm" method="post" enctype="multipart/form-data" action="javascript: uploadAndSubmit();">
            <p>选择上传文件:
                <input type="file" name="file" />
            </p>
            <p>
                <input type="submit" value="确认上传" />
            </p>
        </form>
        <div>上传进度（B）: <span id="bytesRead"> 
 </span> / <span id="bytesTotal"></span>
        </div>
    </p>
</body>

</html>
